<% I18n.locale = :fr%>
<div class="container">
  <div class="card material-shadow my-5" id="event">
    <div class="card-body p-4">

      <div id="carouselInterval" class="carousel-blog slide carousel-fade" data-ride="carousel">
        <div class="carousel-inner">
          <div class="carousel-item active" data-interval="4000">
            <img src="https://images.pexels.com/photos/890507/pexels-photo-890507.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940" class="d-block w-100" alt="...">
            <p>Hello!</p>
          </div>
          <div class="carousel-item" data-interval="4000">
            <img src="https://lhf.glaive.pro/partners/header/1200_140_lhf_2021%20(1)-filters(1200x140).jpg" class="d-block w-100" alt="...">
          </div>
        </div>
      </div>
      
      <hr>

      <div class="card shadow mb-4 animated">

        <div class="card-header bg-white">

          <h1 class="event-title">
          <%= @event.title %>

          <% if @event.event_type.id == 1 %>
            <span class="badge badge-pill badge-success float-right"><%= @event.event_type.name %></span>
          <% elsif @event.event_type.id == 2 %>
            <span class="badge badge-pill badge-danger float-right"><%= @event.event_type.name %></span>
          <% elsif @event.event_type.id == 3 %>
            <span class="badge badge-pill badge-warning float-right"><%= @event.event_type.name %></span>
          <% end %>
          </h1>
        
          <%= image_tag((@event.creator.avatar), class:"d-flex mr-3 event-avatar") %>
          <h5 class="lead mt-3 text-muted creator">
          <% if @event.creator.created_events.length + @event.creator.appointments.length + @event.creator.blogs.length < 9 %>
            <span class="badge badge-light badge-pill mr-1">â˜…</span>
          <% end%>
          <i><%= @event.creator.last_name %> <%= @event.creator.first_name %></i>
          <% if @event.end_date < DateTime.now %>
            <span class="badge badge-pill badge-dark float-right">TerminÃ©</span>
          <% else %>
            <span class="badge badge-pill badge-light float-right">Disponible</span>
          <% end %></h5>

        </div>
        
        <div class="card-body p-2">

          <div class="row">
            <div class="col">

              <% if @event.event_type.id == 1 %>
              <%= image_tag(("https://images.pexels.com/photos/1301856/pexels-photo-1301856.jpeg?auto=compress&cs=tinysrgb&h=750&w=1260"),  class:"img-fluid") %>
              <% elsif @event.event_type.id == 2 %>
              <%= image_tag(("https://images.pexels.com/photos/1508666/pexels-photo-1508666.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940"),  class:"img-fluid") %>
              <% elsif @event.event_type.id == 3 %>
              <%= image_tag(("https://images.pexels.com/photos/2696064/pexels-photo-2696064.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940"),  class:"img-fluid") %>
              <% end %>
              
            </div>
            <div class="col">
              
              <p><strong>CrÃ©Ã© par : </strong>
              <i><%= @event.creator.last_name %> <%= @event.creator.first_name %></i>
              <% if @event.creator.created_events.length + @event.creator.appointments.length + @event.creator.blogs.length < 9 %>
                <span class="badge badge-light badge-pill mr-1">â˜…</span>
              <% end%>
              <% if @event.creator.has_payed == true %>
                <span class="badge badge-light badge-pill mr-1">ðŸŒ±</span>
              <% end %>
              </p>
              <p><strong>Ville :</strong> <%= @event.address.city %>
              <p><strong>Secteur :</strong> <%= @event.address.sector %>
              <p><strong>Type d'Ã©vÃ¨nement : </strong>
              <% if @event.event_type.id == 1 %>
                <span class="badge badge-pill badge-success"><%= @event.event_type.name %></span>
              <% elsif @event.event_type.id == 2 %>
                <span class="badge badge-pill badge-danger"><%= @event.event_type.name %></span>
              <% elsif @event.event_type.id == 3 %>
                <span class="badge badge-pill badge-warning"><%= @event.event_type.name %></span>
              <% end %>
              <p><strong>DÃ©but : </strong><%=l(@event.start_date, format: "%-d %B %Y Ã  %H h %M")%></p>
              <p><strong>Fin : </strong><%=l(@event.end_date, format: "%-d %B %Y Ã  %H h %M")%></p>
              <p><strong>Il y a actuellement <%= @event.appointments.count%> <%= @event.appointments.count > 1 ? 'participants' : 'participant' %></strong></p>

            </div>
          </div>

          <hr>

          <p class="lead"><%= @event.description %></p>     

          <ul class="list-group list-group-flush">
            <li class="list-group-item text-muted">PubliÃ© le <%= l(@event.updated_at, format: "%-d %B %Y")%></li>
          </ul>

          <div class="text-center m-4">

            <!-- Appointment -->

            <% if current_user != @event.creator %>
              <% if @event.end_date > DateTime.now.strftime %>
                <% @appointment = @event.appointments.find { |appointment| appointment.user_id == current_user.id} %>   
                <% if @appointment != nil %>
                  <%= link_to 'Je ne veux plus participer', event_appointment_path(@event.id, @appointment.id), method: :delete, class: 'btn btn-block btn-outline-danger btn-rounded' %>  
                <% else %>
                  <%= link_to 'Participer', new_event_appointment_path(@event.id), class: 'btn btn-block btn-outline-success btn-rounded' %>
                <% end %>
              <% end %>
            <% elsif @event.start_date > DateTime.now %> 
              <%= button_to 'Editer l\'Ã©vÃ¨nement', edit_event_path(@event.id), method: 'get', class: 'btn btn-block btn-outline-warning btn-rounded' %>
              <%= button_to 'Supprimer l\'Ã©vÃ¨nement', event_path(@event.id), params:{destroy_event: true}, method: 'delete', class: 'btn btn-block btn-outline-danger btn-rounded' %>
            <% end %>
            <% if @event.is_passed == true && current_user == @event.creator %>
              <%= button_to 'L\'Ã©vÃ¨nement est passÃ© - Demander les feedbacks ! ', {:controller => "events", :action => "update", :is_passed => true,}, method: 'patch', class: 'btn btn-block btn-outline-warning btn-rounded' %>
            <% end %>          

            <!-- Feedbacks -->

            <hr>

            <div class="row">

              <div class="col">
                <%= link_to "Retour", blogs_path, class:"btn btn-block btn-outline-success btn-rounded" %>
              </div>

              <% if @event.start_date.strftime("%-d %B %Y Ã  %Hh %Mm %Ss") < DateTime.now.strftime("%-d %B %Y Ã  %Hh %Mm %Ss") %>
                <% if user_signed_in? %>  
                  <% if current_user != @event.creator %>
                      <% @appointment = @event.appointments.find { |appointment| appointment.user_id == current_user.id} %> 
                        <% if @appointment != nil %>
                          <div class="col">
                          <%= button_to 'Donner un Feedback', new_event_feedback_path(@event.id), method: 'get', class: 'btn btn-block btn-outline-warning btn-rounded' %>
                          </div>
                        <% end %>
                  <% end %>
                <% end %>
              <% end %>

            </div>

          </div>

          <hr>

          <div class="row">
            <div class="col">

              <%= render 'comments/form' %>
              
              <div id="blog-comment">
                <% @event.comments.order('created_at DESC').each do |comment| %>

                  <div id="event-comment-<%=comment.id%>">
                    <div class="card p-3">    
                      <div class="media">

                        <%= image_tag((comment.user.avatar), class:"d-flex mr-3 rounded-circle avatar") %>
                        <div class="media-body">
                          <li class="float-right">PostÃ© le <%= l(comment.updated_at,format: "%-d %B %Y Ã  %Hh %M") %></li>
                          <h5 class="mt-0 text-muted">
                          <% if comment.user.created_events.length + comment.user.appointments.length + comment.user.blogs.length < 10 %>
                            <span class="badge badge-light badge-pill mr-1">â˜…</span>
                          <% end%>
                          <i><%=  "#{comment.user.first_name}" ' ' "#{comment.user.last_name}"%></i></h5>
                          <p><%= comment.text %></p>
                          
                          <% if user_signed_in? && comment.user == current_user || user_signed_in? && current_user.is_admin == true %>

                      <%= link_to '<i class="fas fa-recycle"></i>'.html_safe, edit_comment_path(comment, comment: { text: comment.text, user_id: comment.user_id, event_id: comment.event_id }), title:"Modifier", class:"btn btn-sm btn-outline-warning btn-rounded m-1" %>
                      <%= link_to '<i class="fas fa-trash-alt"></i>'.html_safe, comment, method: :delete, title:"Supprimer", class:"btn btn-sm btn-outline-danger btn-rounded m-1" %>
                            
                          <% end %>
                        </div>


                      </div>
                    </div>
                  </div>

                <% end %>
              </div>
        
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>
